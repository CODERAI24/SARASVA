rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── User-owned data (private) ─────────────────────────────────────────
    // Covers: subjects, timetables, attendance, exams, tasks, friends
    match /users/{userId}/{document=**} {
      allow read, write: if request.auth != null
                         && request.auth.uid == userId;
    }

    // ── Public profiles for PTP peer search ───────────────────────────────
    // Any authenticated user can search; only the owner can write their own.
    match /publicProfiles/{uid} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == uid;
    }

    // ── Friend requests ───────────────────────────────────────────────────
    match /friendRequests/{requestId} {

      // Only the sender can create a request, must be from themselves
      allow create: if request.auth != null
                    && request.resource.data.fromUid == request.auth.uid
                    && request.resource.data.status  == "pending";

      // Sender or recipient can read the request
      allow read: if request.auth != null
                  && (resource.data.fromUid == request.auth.uid
                   || resource.data.toUid   == request.auth.uid);

      // Sender or recipient can update status (accept / reject)
      allow update: if request.auth != null
                    && (resource.data.fromUid == request.auth.uid
                     || resource.data.toUid   == request.auth.uid);

      // No deletes — statuses are updated, not deleted
      allow delete: if false;
    }

    // ── Study Groups ──────────────────────────────────────────────────────
    // Only members can read/update; creator can delete.
    match /studyGroups/{groupId} {
      allow read:   if request.auth != null
                    && request.auth.uid in resource.data.memberUids;
      allow create: if request.auth != null
                    && request.auth.uid in request.resource.data.memberUids;
      allow update: if request.auth != null
                    && (request.auth.uid in resource.data.memberUids
                     || request.auth.uid in resource.data.pendingInviteUids);
      allow delete: if request.auth != null
                    && request.auth.uid == resource.data.createdBy;

      // Shared posts — members can read/create/update; only author deletes.
      match /posts/{postId} {
        allow read, create: if request.auth != null
          && request.auth.uid in
             get(/databases/$(database)/documents/studyGroups/$(groupId)).data.memberUids;
        allow update: if request.auth != null
          && request.auth.uid in
             get(/databases/$(database)/documents/studyGroups/$(groupId)).data.memberUids;
        allow delete: if request.auth != null
          && request.auth.uid == resource.data.authorUid;
      }
    }

    // ── Group invitations ─────────────────────────────────────────────────
    match /groupInvites/{inviteId} {
      allow create: if request.auth != null
                    && request.resource.data.fromUid == request.auth.uid;
      allow read:   if request.auth != null
                    && (resource.data.fromUid == request.auth.uid
                     || resource.data.toUid   == request.auth.uid);
      allow update: if request.auth != null
                    && (resource.data.fromUid == request.auth.uid
                     || resource.data.toUid   == request.auth.uid);
      allow delete: if false;
    }

  }
}
