rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── User-owned data (private) ─────────────────────────────────────────
    // Covers: subjects, timetables, attendance, exams, tasks, friends
    match /users/{userId}/{document=**} {
      allow read, write: if request.auth != null
                         && request.auth.uid == userId;
    }

    // ── Public profiles for PTP peer search ───────────────────────────────
    // Any authenticated user can search; only the owner can write their own.
    match /publicProfiles/{uid} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == uid;
    }

    // ── Friend requests ───────────────────────────────────────────────────
    match /friendRequests/{requestId} {

      // Only the sender can create a request, must be from themselves
      allow create: if request.auth != null
                    && request.resource.data.fromUid == request.auth.uid
                    && request.resource.data.status  == "pending";

      // Sender or recipient can read the request
      allow read: if request.auth != null
                  && (resource.data.fromUid == request.auth.uid
                   || resource.data.toUid   == request.auth.uid);

      // Sender or recipient can update status (accept / reject)
      allow update: if request.auth != null
                    && (resource.data.fromUid == request.auth.uid
                     || resource.data.toUid   == request.auth.uid);

      // No deletes — statuses are updated, not deleted
      allow delete: if false;
    }

  }
}
